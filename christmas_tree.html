<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script>

var ум = (function() {
    
    var ум = {
        
        выражения: {},
        меткиВыражений: {},
        меткаНовогоВыражения: 1,
        
        собеседники: {},
        меткиСобеседников: {},
        меткаНовогоСобеседника: 1,
        
        рассказы: {},
        меткаНовогоРассказа: 1,
        
        утверждения: {},
        меткаНовогоУтверждения: 1,
        
        действия: {},
        меткиДействий: {},
        меткаНовогоДействия: 1,
        
        вопросы: {},
        меткиВопросов: {},
        меткаНовогоВопроса: 1,
        
        обстоятельства: {},
        меткиОбстоятельств: {},
        меткаНовогоОбстоятельства: 1,
        
        явления: {},
        меткаНовогоЯвления: 1
        
    }
    
    ум.слушай = function(имяСобеседника, записьРассказа) {
        
        var собеседник = ум.узнайСобеседника(имяСобеседника);
        
        ум.разбериРассказ(собеседник, записьРассказа);
        
    }
    
    ум.говори = function(имяСобеседника) {
        
        console.log(ум);
        
    }
    
    ум.узнайВыражение = function(словосочетание) {
        
        var меткаВыражения;
        
        if (ум.меткиВыражений[словосочетание] === undefined) {
            
            меткаВыражения = ум.меткаНовогоВыражения;
            ум.меткаНовогоВыражения++;
            
            ум.меткиВыражений[словосочетание] = меткаВыражения;

            var выражение = {
                метка: меткаВыражения,
                словосочетание: словосочетание,
                вес: 0
            };
            
            ум.выражения[меткаВыражения] = выражение;
            
        } else {
            
            меткаВыражения = ум.меткиВыражений[словосочетание];
            
        }
        
        ум.выражения[меткаВыражения].вес++;
        
        return ум.выражения[меткаВыражения];
        
    }
    
    ум.узнайСобеседника = function(имяСобеседника) {
        
        var меткаВыражения = ум.узнайВыражение(имяСобеседника).метка;
        
        var меткаСобеседника;
        
        if (ум.меткиСобеседников[меткаВыражения] === undefined) {
            
            меткаСобеседника = ум.меткаНовогоСобеседника;
            ум.меткаНовогоСобеседника++;
            
            ум.меткиСобеседников[меткаВыражения] = меткаСобеседника;

            var собеседник = {
                метка: меткаСобеседника,
                меткаВыражения: меткаВыражения,
                меткиРассказов: []
            }
            
            ум.собеседники[меткаСобеседника] = собеседник;
            
        } else {
            
            меткаСобеседника = ум.меткиСобеседников[меткаВыражения];
            
        }
        
        return ум.собеседники[меткаСобеседника];
        
    }
    
    ум.разбериРассказ = function(собеседник, записьРассказа) {
        
        var рассказ = ум.добавьРассказ(собеседник);
        
        for (var названиеДействия in записьРассказа) {
            
            var утверждение = ум.добавьУтверждение(рассказ);
            
            var действие = ум.узнайДействие(названиеДействия, утверждение);

            for (var вопросительноеСлово in записьРассказа[названиеДействия]) {
                
                var вопрос = ум.узнайВопрос(вопросительноеСлово);
                
                ум.разбериОбстоятельства(записьРассказа[названиеДействия][вопросительноеСлово], собеседник, рассказ, утверждение, действие, вопрос);

            }
            
        }
        
    }

    ум.добавьРассказ = function(cобеседник) {
        
        var меткаРассказа = ум.меткаНовогоРассказа;
        ум.меткаНовогоРассказа++;
        
        var рассказ = {
            метка: меткаРассказа,
            меткаСобеседника: cобеседник.метка,
            меткиУтверждений: []
        }
        
        ум.рассказы[меткаРассказа] = рассказ;
        
        cобеседник.меткиРассказов.push(меткаРассказа);
        
        return рассказ;
        
    }
    
    ум.добавьУтверждение = function(рассказ) {
        
        var меткаУтверждения = ум.меткаНовогоУтверждения;
        ум.меткаНовогоУтверждения++;
        
        var утверждение = {
            метка: меткаУтверждения,
            меткаРассказа: рассказ.метка,
            меткаДействия: null,
            меткиОбстоятельств: [],
            названияЯвлений: {}
        }

        var рассказНачат = (рассказ.меткиУтверждений.length > 0);
        
        if (рассказНачат) {
            
            // повторяем контекст
            
            var меткаПредыдущегоУтверждения = рассказ.меткиУтверждений[рассказ.меткиУтверждений.length - 1];

            var предыдущееУтверждение = ум.утверждения[меткаПредыдущегоУтверждения];

            for (var меткаВыражения in предыдущееУтверждение.названияЯвлений) {

                var меткаЯвления = предыдущееУтверждение.названияЯвлений[меткаВыражения];
                
                утверждение.названияЯвлений[меткаВыражения] = меткаЯвления;

            }
            
        }

        ум.утверждения[меткаУтверждения] = утверждение;
        
        рассказ.меткиУтверждений.push(меткаУтверждения);
        
        return утверждение;
        
    }
    
    ум.узнайДействие = function(названиеДействия, утверждение) {
        
        var меткаВыражения = ум.узнайВыражение(названиеДействия).метка;
        
        var меткаДействия;
        
        if (ум.меткиДействий[меткаВыражения] === undefined) {
            
            меткаДействия = ум.меткаНовогоДействия;
            ум.меткаНовогоДействия++;
            
            ум.меткиДействий[меткаВыражения] = меткаДействия;

            var действие = {
                метка: меткаДействия,
                меткаВыражения: меткаВыражения,
                меткиУтверждений: [],
                меткиОбстоятельств: {},
                меткиДействий: {} // меткаОбстоятельства: [меткаДействия_1, ...]
            }
            
            ум.действия[меткаДействия] = действие;
            
        } else {
            
            меткаДействия = ум.меткиДействий[меткаВыражения];
            
        }
        
        ум.действия[меткаДействия].меткиУтверждений.push(утверждение.метка);
        утверждение.меткаДействия = ум.действия[меткаДействия].метка;
        
        return ум.действия[меткаДействия];
        
    }
    
    ум.узнайВопрос = function(вопросительноеСлово) {
        
        var меткаВыражения = ум.узнайВыражение(вопросительноеСлово).метка;
        
        var меткаВопроса;
        
        if (ум.меткиВопросов[меткаВыражения] === undefined) {
            
            меткаВопроса = ум.меткаНовогоВопроса;
            ум.меткаНовогоВопроса++;
            
            ум.меткиВопросов[меткаВыражения] = меткаВопроса;

            var вопрос = {
                метка: меткаВопроса,
                меткаВыражения: меткаВыражения,
                меткиОбстоятельств: {}
            }
            
            ум.вопросы[меткаВопроса] = вопрос;
            
        } else {
            
            меткаВопроса = ум.меткиВопросов[меткаВыражения];
            
        }
        
        return ум.вопросы[меткаВопроса];
        
    }
    
    ум.узнайОбстоятельство = function(названиеОбстоятельства, утверждение, действие, вопрос) {
        
        var меткаВыражения = ум.узнайВыражение(названиеОбстоятельства).метка;
        
        var меткаОбстоятельства, обстоятельство;
        
        if (ум.меткиОбстоятельств[меткаВыражения] === undefined) {
            
            меткаОбстоятельства = ум.меткаНовогоОбстоятельства;
            ум.меткаНовогоОбстоятельства++;
            
            ум.меткиОбстоятельств[меткаВыражения] = меткаОбстоятельства;

            обстоятельство = {
                метка: меткаОбстоятельства,
                меткаВыражения: меткаВыражения,
                меткиУтверждений: [],
                меткиДействий: {},
                меткиВопросов: {},
                меткиЯвлений: []
            }
            
            ум.обстоятельства[меткаОбстоятельства] = обстоятельство;
            
        } else {
            
            меткаОбстоятельства = ум.меткиОбстоятельств[меткаВыражения];
            
            обстоятельство = ум.обстоятельства[меткаОбстоятельства];
            
        }
        
        // утверждение
        
        обстоятельство.меткиУтверждений.push(утверждение.метка);
        утверждение.меткиОбстоятельств.push(обстоятельство.метка);
        
        if (утверждение.названияЯвлений[обстоятельство.меткаВыражения] !== undefined) {
            
            var меткаЯвления = утверждение.названияЯвлений[обстоятельство.меткаВыражения];
            var явление = ум.явления[меткаЯвления];
            
            явление.меткиУтверждений.push(утверждение.метка);
            
            if (явление.меткиОбстоятельств[обстоятельство.метка] === undefined) {
                явление.меткиОбстоятельств[обстоятельство.метка] = 1;
            } else {
                явление.меткиОбстоятельств[обстоятельство.метка]++;
            }
            
        }
    
        // действие
        
        if (действие.меткиОбстоятельств[вопрос.метка] === undefined) {
            действие.меткиОбстоятельств[вопрос.метка] = {};
        }
        
        if (действие.меткиОбстоятельств[вопрос.метка][обстоятельство.метка] === undefined) {
            действие.меткиОбстоятельств[вопрос.метка][обстоятельство.метка] = 1;
        } else {
            действие.меткиОбстоятельств[вопрос.метка][обстоятельство.метка]++;
        }
        
        if (обстоятельство.меткиДействий[действие.метка] === undefined) {
            обстоятельство.меткиДействий[действие.метка] = 1;
        } else {
            обстоятельство.меткиДействий[действие.метка]++;
        }
        
        // вопрос
        
        if (обстоятельство.меткиВопросов[вопрос.метка] === undefined) {
            обстоятельство.меткиВопросов[вопрос.метка] = 1;
        } else {
            обстоятельство.меткиВопросов[вопрос.метка]++;
        }
        
        if (вопрос.меткиОбстоятельств[обстоятельство.метка] === undefined) {
            вопрос.меткиОбстоятельств[обстоятельство.метка] = 1;
        } else {
            вопрос.меткиОбстоятельств[обстоятельство.метка]++;
        }
        
        return обстоятельство;
        
    }
    
    ум.разбериОбстоятельства = function(названияОбстоятельств, собеседник, рассказ, утверждение, действие, вопрос) {
        
        for (var номер in названияОбстоятельств) {

            var названиеОбстоятельства = null;
            var поисковоеЗадание = null;

            var рассматриваемСсылку = (typeof названияОбстоятельств[номер] !== "string");

            if (рассматриваемСсылку) {

                for (var названиеОбстоятельства in названияОбстоятельств[номер]) {
                    
                    var обстоятельство = ум.узнайОбстоятельство(названиеОбстоятельства, утверждение, действие, вопрос);

                    var поисковоеЗадание = названияОбстоятельств[номер][названиеОбстоятельства];
                    
                    ум.поймиСсылку(поисковоеЗадание, обстоятельство, собеседник, утверждение, действие);

                }

            } else {

                var названиеОбстоятельства = названияОбстоятельств[номер];
                
                var обстоятельство = ум.узнайОбстоятельство(названиеОбстоятельства, утверждение, действие, вопрос);


            }

        }
        
    }
    
    ум.поймиСсылку = function(поисковоеЗадание, обстоятельство, собеседник, утверждение, действие) {
       
        if (ум.меткиВыражений[поисковоеЗадание] === undefined) {
            throw new Error("В ссылке ошибка 1." + поисковоеЗадание);
        }
        
        var меткаВыражения = ум.меткиВыражений[поисковоеЗадание];
        
        var выражение = ум.выражения[меткаВыражения];

        var найдено = ум.найдиПоследнееУпотребление(собеседник, выражение);
        
        if (найдено.действие !== undefined) {
            
            if (действие.меткиДействий[обстоятельство.метка] === undefined) {
                действие.меткиДействий[обстоятельство.метка] = [];
            }
            
            if (!(найдено.действие.метка in действие.меткиДействий[обстоятельство.метка])) {
                действие.меткиДействий[обстоятельство.метка].push(найдено.действие.метка);
            }

        } else if (найдено.обстоятельство !== undefined) {
            
            var явлениеУпоминалосьВРассказе = (найдено.утверждение.названияЯвлений[найдено.обстоятельство.меткаВыражения] !== undefined);

            if (явлениеУпоминалосьВРассказе) {
                
                var меткаЯвления = найдено.утверждение.названияЯвлений[найдено.обстоятельство.меткаВыражения];

                var явление = ум.явления[меткаЯвления];

            } else {
                
                var явление = ум.добавьЯвление(найдено.утверждение, найдено.обстоятельство);

                найдено.утверждение.названияЯвлений[найдено.обстоятельство.меткаВыражения] = явление.метка;
                утверждение.названияЯвлений[найдено.обстоятельство.меткаВыражения] = явление.метка;

            }
            
            явление.меткиУтверждений.push(утверждение.метка);

            утверждение.названияЯвлений[обстоятельство.меткаВыражения] = явление.метка;
            
            if (явление.меткиОбстоятельств[обстоятельство.метка] === undefined) {
                явление.меткиОбстоятельств[обстоятельство.метка] = 1;
            } else {
                явление.меткиОбстоятельств[обстоятельство.метка]++;
            }

        } else {

            throw new Error("В ссылке ошибка 2");

        }
        
    }
    
    ум.найдиПоследнееУпотребление = function(собеседник, выражение) {
        
        var номерПоследенегоРассказа = собеседник.меткиРассказов.length - 1;
        
        for (var номерРассказа = номерПоследенегоРассказа; номерРассказа >= 0; номерРассказа--) {
            
            var меткаРассказа = собеседник.меткиРассказов[номерРассказа];
            
            var рассказ = ум.рассказы[меткаРассказа];
            
            var меткаПоследнегоУтверждения = рассказ.меткиУтверждений.length - 1;
          
            for (var номерУтверждения = меткаПоследнегоУтверждения; номерУтверждения >= 0; номерУтверждения--) {
                
                var меткаУтверждения = рассказ.меткиУтверждений[номерУтверждения];
                
                var утверждение = ум.утверждения[меткаУтверждения];

                var найдено = ум.найдиВыражениеВУтверждении(утверждение, выражение);
                
                if (найдено.действие || найдено.обстоятельство) {
                    
                    return найдено;
                    
                }

            }
            
        }
        
        return {};
        
    }
    
    ум.найдиВыражениеВУтверждении = function(утверждение, выражение) {
        
        var действие = ум.действия[утверждение.меткаДействия];
        
        if (действие.меткаВыражения === выражение.метка) {
            
            return {
                "действие": действие,
                "утверждение": утверждение
            }
            
        } else {
            
            var номерПоследнегоОбстоятельства = утверждение.меткиОбстоятельств.length - 1;
            
            for (var номерОбстоятельства = номерПоследнегоОбстоятельства; номерОбстоятельства >= 0; номерОбстоятельства--) {
                
                var меткаОбстоятельства = утверждение.меткиОбстоятельств[номерОбстоятельства];
                
                var обстоятельство = ум.обстоятельства[меткаОбстоятельства];

                if (обстоятельство.меткаВыражения === выражение.метка) {
                    
                    return {
                        "обстоятельство": обстоятельство,
                        "утверждение": утверждение
                    }
                    
                }
                
            }
            
        }
        
        return {};
        
    }
    
    ум.добавьЯвление = function(утверждение, обстоятельство) {
        
        var меткаЯвления = ум.меткаНовогоЯвления;
        ум.меткаНовогоЯвления++;
        
        var явление = {
            метка: меткаЯвления,
            меткиЯвлений: {}, // на случай упоминания одного и того же явления другими собеседниками или в других рассказах
            меткиОбстоятельств: {},
            меткиУтверждений: [утверждение.метка]
        }
        
        явление.меткиОбстоятельств[обстоятельство.метка] = 1;
        
        ум.явления[меткаЯвления] = явление;
        
        утверждение.названияЯвлений[обстоятельство.меткаВыражения] = явление.метка;
        
        return явление;
        
    }
    
    return {
        слушай: ум.слушай,
        говори: ум.говори
    }
    
})();

ум.слушай("Иванов", {
    "родилась": {
        "кто": ["ёлочка"],
        "где": ["в лесу"]
    },
    "росла": {
        "кто": [{"она": "ёлочка"}],
        "где": ["в лесу"]
    },
    "была": {
        "кто": ["она"],
        "какая": ["стройная", "зелёная"],
        "когда": ["летом", "зимой"]
    },
    "пела": {
        "кто": ["метель"],
        "кому": [{"ей": "она"}],
        "что": ["песенку"]
    },
    "укутывал": {
        "кто": ["мороз"],
        "чем": ["снежком"]
    },
    "не мёрзла": {
        "кто": ["ёлочка"],
        "почему": [{"потому что": "укутывал"}]
    }
});

ум.говори("Иванов");

</script>
</head>
</html>